<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - å‡ºå‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    .top-bar {
      max-width: 1400px;
      margin: 0 auto 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .top-bar h1 {
      font-size: 24px;
      color: #333;
    }
    .top-bar a {
      padding: 10px 20px;
      background-color: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .top-bar a:hover {
      background-color: #5568d3;
    }
    .header {
      max-width: 1400px;
      margin: 0 auto 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .tab-button {
      padding: 12px 30px;
      font-size: 16px;
      background-color: #ddd;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: none;
    }
    .container.active {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .container.active.full {
      grid-template-columns: 1fr;
    }
    .section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      font-size: 24px;
      margin-bottom: 20px;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    h3 {
      font-size: 18px;
      margin-top: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    label {
      display: block;
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    button.danger {
      background-color: #f44336;
    }
    button.danger:hover {
      background-color: #da190b;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .person-item {
      background-color: #f9f9f9;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    .person-item strong {
      font-size: 18px;
      display: block;
      margin-bottom: 8px;
    }
    .person-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .person-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .person-stat {
      background-color: white;
      padding: 8px;
      border-radius: 3px;
      text-align: center;
    }
    .person-stat-value {
      font-weight: bold;
      color: #4CAF50;
      font-size: 18px;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
      body {
        background-color: white;
        padding: 0;
      }
      .top-bar, .header, .no-print {
        display: none !important;
      }
      .container {
        display: block !important;
        max-width: none;
      }
      .print-page {
        page-break-after: always;
        padding: 15mm;
      }
      .print-page:last-child {
        page-break-after: auto;
      }
    }

    /* æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .print-page {
      background: white;
      margin: 20px auto;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 210mm;
    }
    .report-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .report-header h2 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .report-header .month {
      font-size: 20px;
      color: #666;
    }
    .employee-info {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .employee-info table {
      width: 100%;
      border: none;
    }
    .employee-info td {
      padding: 8px;
      border: none;
    }
    .employee-info td:first-child {
      font-weight: bold;
      width: 150px;
      background-color: #e8e8e8;
    }
    .calendar-container {
      margin-top: 20px;
    }
    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .calendar {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .calendar th {
      background-color: #4CAF50;
      color: white;
      padding: 10px;
      font-size: 14px;
    }
    .calendar td {
      width: 14.28%;
      height: 60px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: top;
      padding: 5px;
      position: relative;
    }
    .calendar .day-number {
      font-size: 16px;
      font-weight: bold;
    }
    .calendar .attendance-mark {
      font-size: 32px;
      color: #4CAF50;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .calendar .sunday {
      background-color: #ffe0e0;
    }
    .calendar .saturday {
      background-color: #e0e8ff;
    }
    .calendar .other-month {
      background-color: #f5f5f5;
      color: #ccc;
    }
    .summary-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f8f0;
      border-radius: 5px;
      border: 2px solid #4CAF50;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 10px;
    }
    .summary-item {
      padding: 10px;
      background-color: white;
      border-radius: 3px;
    }
    .summary-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .summary-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>ğŸ”§ ç®¡ç†ç”»é¢</h1>
    <a href="attendance.html">ğŸ“ å‡ºå‹¤è¨˜éŒ²ã¸</a>
  </div>

  <div class="header">
    <button class="tab-button active" onclick="switchTab('today')">æœ¬æ—¥ã®å‡ºå‹¤</button>
    <button class="tab-button" onclick="switchTab('manual')">æ‰‹å‹•è¨˜éŒ²</button>
    <button class="tab-button" onclick="switchTab('management')">äººå“¡ç®¡ç†</button>
    <button class="tab-button" onclick="switchTab('stats')">çµ±è¨ˆ</button>
    <button class="tab-button" onclick="switchTab('monthly')">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
  </div>

  <!-- æœ¬æ—¥ã®å‡ºå‹¤ã‚¿ãƒ– -->
  <div id="today" class="container active full">
    <div class="section">
      <h2>æœ¬æ—¥ã®å‡ºå‹¤çŠ¶æ³</h2>
      <div id="todayStats"></div>
    </div>
  </div>

  <!-- æ‰‹å‹•è¨˜éŒ²ã‚¿ãƒ– -->
  <div id="manual" class="container active full">
    <div class="section">
      <h2>æ‰‹å‹•ã§å‡ºå‹¤è¨˜éŒ²ã‚’è¿½åŠ </h2>
      <p style="color: #666; margin-bottom: 20px;">â€» ç®¡ç†è€…ç”¨ï¼šå ´æ‰€ãƒ»å›æ•°åˆ¶é™ãªã—ã§è¨˜éŒ²ã‚’è¿½åŠ ã§ãã¾ã™</p>
      
      <form id="manualRecordForm">
        <label for="manualPersonSelect">æ°å:</label>
        <select id="manualPersonSelect" required>
          <option value="">--- é¸æŠã—ã¦ãã ã•ã„ ---</option>
        </select>

        <label for="manualDate">æ—¥ä»˜:</label>
        <input type="date" id="manualDate" required>

        <label for="manualTime">æ™‚åˆ»:</label>
        <input type="time" id="manualTime" required>

        <label>äº¤é€šçµŒè·¯:</label>
        <div style="margin-bottom: 15px;">
          <label style="display: inline-flex; align-items: center; margin-right: 20px;">
            <input type="radio" name="manualRoute" value="å®¶â†’äº‹å‹™æ‰€" required style="margin-right: 8px;">
            å®¶â†’äº‹å‹™æ‰€
          </label>
          <label style="display: inline-flex; align-items: center;">
            <input type="radio" name="manualRoute" value="å­¦æ ¡â†’äº‹å‹™æ‰€" style="margin-right: 8px;">
            å­¦æ ¡â†’äº‹å‹™æ‰€
          </label>
        </div>

        <button type="submit" id="manualSubmitBtn">è¨˜éŒ²ã‚’è¿½åŠ </button>
      </form>
    </div>
  </div>

  <!-- äººå“¡ç®¡ç†ã‚¿ãƒ– -->
  <div id="management" class="container active full">
    <div class="section">
      <h2>äººå“¡ç®¡ç†</h2>
      
      <h3>æ–°ã—ã„äººã‚’è¿½åŠ </h3>
      <form id="personForm">
        <label for="personName">æ°å:</label>
        <input type="text" id="personName" required>

        <label for="homeStation">æœ€å¯„ã‚Šé§…ï¼ˆå®¶ï¼‰:</label>
        <input type="text" id="homeStation" required>

        <label for="homeFare">å¾€å¾©äº¤é€šè²»ï¼ˆå®¶â†’äº‹å‹™æ‰€ï¼‰ (å††):</label>
        <input type="number" id="homeFare" min="0" required>

        <label for="universityStation">å¤§å­¦æœ€å¯„ã‚Šé§…:</label>
        <input type="text" id="universityStation" required>

        <label for="universityFare">å¾€å¾©äº¤é€šè²»ï¼ˆå­¦æ ¡â†’äº‹å‹™æ‰€ï¼‰ (å††):</label>
        <input type="number" id="universityFare" min="0" required>

        <button type="submit" id="addPersonBtn">ç™»éŒ²</button>
      </form>

      <h3>ç™»éŒ²æ¸ˆã¿ã®äºº</h3>
      <div id="personList"></div>
    </div>
  </div>

  <!-- çµ±è¨ˆã‚¿ãƒ– -->
  <div id="stats" class="container active full">
    <div class="section">
      <h2>å‡ºå‹¤çµ±è¨ˆ</h2>
      <div id="statsContent"></div>
    </div>
  </div>

  <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
  <div id="monthly" class="container active full">
    <div class="section no-print">
      <h2>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
      <label for="monthSelect">æœˆã‚’é¸æŠ:</label>
      <select id="monthSelect" onchange="updateMonthlyReport()">
        <option value="">--- é¸æŠã—ã¦ãã ã•ã„ ---</option>
      </select>
      <button onclick="window.print()" style="margin-top: 20px;">å°åˆ·</button>
    </div>

    <div id="monthlyReportContent"></div>
  </div>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDwCSI2kDqV7eMPqwBh0nNDORdGtw5aydQ",
      authDomain: "kdaikda.firebaseapp.com",
      projectId: "kdaikda",
      storageBucket: "kdaikda.firebasestorage.app",
      messagingSenderId: "640889239505",
      appId: "1:640889239505:web:993aa3aba77560837f12f0"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let people = [];
    let records = [];

    // çµ±ä¸€ã•ã‚ŒãŸæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function getDateString(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}/${m}/${d}`;
    }

    // çµ±ä¸€ã•ã‚ŒãŸæ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function getTimeString(date) {
      const h = String(date.getHours()).padStart(2, '0');
      const m = String(date.getMinutes()).padStart(2, '0');
      const s = String(date.getSeconds()).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      try {
        // äººå“¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        const peopleSnapshot = await db.collection('people').get();
        people = peopleSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // å‡ºå‹¤è¨˜éŒ²èª­ã¿è¾¼ã¿
        const recordsSnapshot = await db.collection('records').orderBy('timestamp', 'desc').get();
        records = recordsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        updatePersonList();
        updateTodayStats();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      // ã‚¿ãƒ–å›ºæœ‰ã®å‡¦ç†ã‚’ä¸€å…ƒç®¡ç†
      switch(tabName) {
        case 'stats':
          updateStats();
          break;
        case 'management':
          updatePersonList();
          break;
        case 'today':
          updateTodayStats();
          break;
        case 'monthly':
          populateMonthSelect();
          break;
        case 'manual':
          updateManualForm();
          break;
      }
    }

    // æ‰‹å‹•è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°
    function updateManualForm() {
      const select = document.getElementById('manualPersonSelect');
      const options = '<option value="">--- é¸æŠã—ã¦ãã ã•ã„ ---</option>' + 
        people.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      select.innerHTML = options;

      // ä»Šæ—¥ã®æ—¥ä»˜ã¨ç¾åœ¨æ™‚åˆ»ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
      const now = new Date();
      document.getElementById('manualDate').valueAsDate = now;
      document.getElementById('manualTime').value = now.toTimeString().substring(0, 5);
    }

    // äººã‚’è¿½åŠ 
    document.getElementById('personForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const name = document.getElementById('personName').value;
      const homeStation = document.getElementById('homeStation').value;
      const homeFare = parseInt(document.getElementById('homeFare').value);
      const universityStation = document.getElementById('universityStation').value;
      const universityFare = parseInt(document.getElementById('universityFare').value);

      if (people.some(p => p.name === name)) {
        alert('ã“ã®åå‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }

      const submitBtn = document.getElementById('addPersonBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'ç™»éŒ²ä¸­...';

      try {
        const personData = {
          name: name,
          homeStation: homeStation,
          homeFare: homeFare,
          universityStation: universityStation,
          universityFare: universityFare,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docRef = await db.collection('people').add(personData);
        const person = { id: docRef.id, ...personData };
        people.push(person);

        this.reset();
        updatePersonList();
        alert('äººã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ç™»éŒ²';
      }
    });

    // äººã‚’å‰Šé™¤
    async function deletePerson(id) {
      if (confirm('ã“ã®äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        try {
          await db.collection('people').doc(id).delete();
          people = people.filter(p => p.id !== id);
          updatePersonList();
        } catch (error) {
          console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    }

    // äººå“¡ãƒªã‚¹ãƒˆæ›´æ–°
    function updatePersonList() {
      const html = people.map(p => {
        const count = records.filter(r => r.personId === p.id).length;
        return `
          <div class="person-item">
            <strong>${p.name}</strong>
            <div class="person-info">
              å®¶æœ€å¯„ã‚Šé§…: ${p.homeStation} (Â¥${p.homeFare.toLocaleString()}) | 
              å¤§å­¦æœ€å¯„ã‚Šé§…: ${p.universityStation} (Â¥${p.universityFare.toLocaleString()})
            </div>
            <div class="person-stats">
              <div class="person-stat">
                <div>å‡ºå‹¤å›æ•°</div>
                <div class="person-stat-value">${count}</div>
              </div>
              <div class="person-stat">
                <div>äº¤é€šè²»åˆè¨ˆ</div>
                <div class="person-stat-value">Â¥${(p.homeFare * count).toLocaleString()}</div>
              </div>
              <div class="person-stat">
                <div></div>
                <button class="danger" style="padding: 5px 10px; font-size: 14px; margin: 0;" onclick="deletePerson('${p.id}')">å‰Šé™¤</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('personList').innerHTML = html || '<p>ç™»éŒ²è€…ãŒã„ã¾ã›ã‚“</p>';
    }

    // æœ¬æ—¥ã®å‡ºå‹¤çŠ¶æ³
    function updateTodayStats() {
      const today = getDateString(new Date());
      const todayRecords = records.filter(r => r.date === today);

      const html = todayRecords.length === 0 ? '<p>æœ¬æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>' : `
        <table>
          <thead>
            <tr>
              <th>æ°å</th>
              <th>æ™‚åˆ»</th>
              <th>çµŒè·¯</th>
              <th>è·é›¢</th>
            </tr>
          </thead>
          <tbody>
            ${todayRecords.map(r => `
              <tr>
                <td>${r.personName}</td>
                <td>${r.time}</td>
                <td>${r.route}</td>
                <td>${Math.round(r.distance)}m</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      document.getElementById('todayStats').innerHTML = html;
    }

    // çµ±è¨ˆè¡¨ç¤º
    function updateStats() {
      const stats = people.map(p => {
        const pRecords = records.filter(r => r.personId === p.id);
        const homeCount = pRecords.filter(r => r.route === 'å®¶â†’äº‹å‹™æ‰€').length;
        const schoolCount = pRecords.filter(r => r.route === 'å­¦æ ¡â†’äº‹å‹™æ‰€').length;
        const totalFare = p.homeFare * homeCount + p.universityFare * schoolCount;

        return { name: p.name, homeCount, schoolCount, totalFare, total: pRecords.length };
      });

      const html = `
        <table>
          <thead>
            <tr>
              <th>æ°å</th>
              <th>å®¶â†’äº‹å‹™æ‰€</th>
              <th>å­¦æ ¡â†’äº‹å‹™æ‰€</th>
              <th>åˆè¨ˆå‡ºå‹¤</th>
              <th>äº¤é€šè²»åˆè¨ˆ</th>
            </tr>
          </thead>
          <tbody>
            ${stats.map(s => `
              <tr>
                <td>${s.name}</td>
                <td>${s.homeCount}</td>
                <td>${s.schoolCount}</td>
                <td>${s.total}</td>
                <td>Â¥${s.totalFare.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      document.getElementById('statsContent').innerHTML = html || '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    // æœˆé¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    function populateMonthSelect() {
      const monthSelect = document.getElementById('monthSelect');
      const months = new Set();
      
      records.forEach(r => {
        if (r.date) {
          const parts = r.date.split('/');
          if (parts.length === 3) {
            const monthKey = `${parts[0]}/${parts[1]}`;
            months.add(monthKey);
          }
        }
      });

      const sortedMonths = Array.from(months).sort((a, b) => {
        const [yearA, monthA] = a.split('/').map(Number);
        const [yearB, monthB] = b.split('/').map(Number);
        return yearB * 12 + monthB - (yearA * 12 + monthA);
      });

      monthSelect.innerHTML = '<option value="">--- é¸æŠã—ã¦ãã ã•ã„ ---</option>' +
        sortedMonths.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
    function generateCalendar(year, month, attendanceDates) {
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      const daysInMonth = lastDay.getDate();
      const startDay = firstDay.getDay();

      let html = '<table class="calendar"><thead><tr>';
      ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach(day => {
        html += `<th>${day}</th>`;
      });
      html += '</tr></thead><tbody><tr>';

      // å‰æœˆã®ç©ºç™½
      for (let i = 0; i < startDay; i++) {
        html += '<td class="other-month"></td>';
      }

      // æ—¥ä»˜ã‚’è¡¨ç¤º
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        const dateStr = `${year}/${month}/${day}`;
        const hasAttendance = attendanceDates.includes(dateStr);

        let className = '';
        if (dayOfWeek === 0) className = 'sunday';
        else if (dayOfWeek === 6) className = 'saturday';

        html += `<td class="${className}">
          <div class="day-number">${day}</div>
          ${hasAttendance ? '<div class="attendance-mark">Ã—</div>' : ''}
        </td>`;

        if (dayOfWeek === 6 && day < daysInMonth) {
          html += '</tr><tr>';
        }
      }

      // æ¬¡æœˆã®ç©ºç™½
      const endDay = lastDay.getDay();
      for (let i = endDay + 1; i < 7; i++) {
        html += '<td class="other-month"></td>';
      }

      html += '</tr></tbody></table>';
      return html;
    }

    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ›´æ–°
    function updateMonthlyReport() {
      const monthValue = document.getElementById('monthSelect').value;
      if (!monthValue) {
        document.getElementById('monthlyReportContent').innerHTML = '';
        return;
      }

      const [year, month] = monthValue.split('/').map(Number);
      
      // ãã®æœˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿
      const monthRecords = records.filter(r => {
        if (!r.date) return false;
        const parts = r.date.split('/');
        return parts.length === 3 && 
               parseInt(parts[0]) === year && 
               parseInt(parts[1]) === month;
      });

      // äººã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
      const reportsHtml = people.map(person => {
        const personRecords = monthRecords.filter(r => r.personId === person.id);
        const homeCount = personRecords.filter(r => r.route === 'å®¶â†’äº‹å‹™æ‰€').length;
        const schoolCount = personRecords.filter(r => r.route === 'å­¦æ ¡â†’äº‹å‹™æ‰€').length;
        const totalFare = person.homeFare * homeCount + person.universityFare * schoolCount;
        
        // å‡ºå‹¤æ—¥ã®ãƒªã‚¹ãƒˆ
        const attendanceDates = personRecords.map(r => r.date);

        return `
          <div class="print-page">
            <div class="report-header">
              <h2>å‡ºå‹¤ç®¡ç†æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
              <div class="month">${year}å¹´${month}æœˆ</div>
            </div>

            <div class="employee-info">
              <table>
                <tr>
                  <td>æ°å</td>
                  <td>${person.name}</td>
                </tr>
                <tr>
                  <td>å®¶ æœ€å¯„ã‚Šé§…</td>
                  <td>${person.homeStation}</td>
                </tr>
                <tr>
                  <td>å®¶ å¾€å¾©äº¤é€šè²»</td>
                  <td>Â¥${person.homeFare.toLocaleString()}</td>
                </tr>
                <tr>
                  <td>å¤§å­¦ æœ€å¯„ã‚Šé§…</td>
                  <td>${person.universityStation}</td>
                </tr>
                <tr>
                  <td>å¤§å­¦ å¾€å¾©äº¤é€šè²»</td>
                  <td>Â¥${person.universityFare.toLocaleString()}</td>
                </tr>
              </table>
            </div>

            <div class="calendar-container">
              <div class="calendar-title">å‡ºå‹¤ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆÃ—å°ãŒå‡ºå‹¤æ—¥ï¼‰</div>
              ${generateCalendar(year, month, attendanceDates)}
            </div>

            <div class="summary-section">
              <h3>ä»Šæœˆã®é›†è¨ˆ</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <div class="summary-label">å®¶â†’äº‹å‹™æ‰€</div>
                  <div class="summary-value">${homeCount}å›</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">å­¦æ ¡â†’äº‹å‹™æ‰€</div>
                  <div class="summary-value">${schoolCount}å›</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">åˆè¨ˆå‡ºå‹¤æ—¥æ•°</div>
                  <div class="summary-value">${personRecords.length}æ—¥</div>
                </div>
                <div class="summary-item">
                  <div class="summary-label">äº¤é€šè²»åˆè¨ˆ</div>
                  <div class="summary-value">Â¥${totalFare.toLocaleString()}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('monthlyReportContent').innerHTML = reportsHtml || '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }

    // æ‰‹å‹•è¨˜éŒ²ã®è¿½åŠ 
    document.getElementById('manualRecordForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const personId = document.getElementById('manualPersonSelect').value;
      const person = people.find(p => p.id === personId);
      const dateInput = document.getElementById('manualDate').value;
      const timeInput = document.getElementById('manualTime').value;
      const route = document.querySelector('input[name="manualRoute"]:checked').value;

      // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ› (YYYY-MM-DD â†’ YYYY/MM/DD)
      const [year, month, day] = dateInput.split('-');
      const formattedDate = `${year}/${parseInt(month)}/${parseInt(day)}`;

      const submitBtn = document.getElementById('manualSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'è¨˜éŒ²ä¸­...';

      try {
        const recordData = {
          personId: person.id,
          personName: person.name,
          route: route,
          date: formattedDate,
          time: timeInput + ':00',
          lat: 0,  // æ‰‹å‹•è¨˜éŒ²ã¯ä½ç½®æƒ…å ±ãªã—
          lng: 0,
          distance: 0,
          manual: true,  // æ‰‹å‹•è¨˜éŒ²ãƒ•ãƒ©ã‚°
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('records').add(recordData);
        records.unshift({ id: Date.now(), ...recordData });

        this.reset();
        updateManualForm();  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        alert('è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨˜éŒ²ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'è¨˜éŒ²ã‚’è¿½åŠ ';
      }
    });

    // åˆæœŸåŒ–
    loadData();
  </script>
</body>
</html>
